<?php\n\nnamespace App\\Http\\Controllers\\Auth;\n\nuse App\\Http\\Controllers\\Controller;\nuse App\\Models\\User;\nuse App\\Models\\Tenant;\nuse App\\Models\\Role;\nuse App\\Models\\Permission;\nuse Illuminate\\Auth\\Events\\Registered;\nuse Illuminate\\Http\\RedirectResponse;\nuse Illuminate\\Http\\Request;\nuse Illuminate\Support\\Facades\\Auth;\nuse Illuminate\\Support\\Facades\\DB;\nuse Illuminate\\Support\\Facades\\Hash;\nuse Illuminate\\Validation\\Rules;\nuse Illuminate\\View\\View;\n\nclass RegisteredUserController extends Controller\n{\n    /**\n     * Display the registration view.\n     */\n    public function create(): View\n    {\n        return view(\'auth.register\');\n    }\n\n    /**\n     * Handle an incoming registration request.\n     *\n     * @throws \\Illuminate\\Validation\\ValidationException\n     */\n    public function store(Request $request): RedirectResponse\n    {\n        $request->validate([\n            \'name\' => [\'required\', \'string\', \'max:255\'],\n            \'email\' => [\'required\', \'string\', \'lowercase\', \'email\', \'max:255\', \'unique:\'.User::class],\n            \'password\' => [\'required\', \'confirmed\', Rules\\Password::defaults()],\n        ]);\n\n        $user = DB::transaction(function () use ($request) {\n            $tenant = Tenant::create([\'name\' => $request->name . \"\'s Team\"]);\n\n            // Set tenant id in session for the TenantScope to work\n            session([\'tenant_id\' => $tenant->id]);\n\n            // Create permissions\n            $permissions = [\n                \'manage billing\', \'invite users\', \'manage campaigns\', \'create leads\', \'delete leads\'\n            ];\n            foreach ($permissions as $permission) {\n                Permission::create([\'name\' => $permission]);\n            }\n\n            // Create roles\n            $owner = Role::create([\'name\' => \'owner\']);\n            $admin = Role::create([\'name\' => \'admin\']);\n            $member = Role::create([\'name\' => \'member\']);\n\n            // Assign permissions to roles\n            $owner->givePermissionTo(Permission::all());\n            $admin->givePermissionTo([\'manage campaigns\', \'create leads\', \'delete leads\', \'invite users\']);\n            $member->givePermissionTo([\'create leads\']);\n\n            $user = $tenant->users()->create([\n                \'name\' => $request->name,\n                \'email\' => $request->email,\n                \'password\' => Hash::make($request->password),\n            ]);\n\n            $user->assignRole($owner);\n\n            // Clear tenant id from session\n            session()->forget(\'tenant_id\');\n\n            return $user;\n        });\n\n        event(new Registered($user));\n\n        Auth::login($user);\n\n        return redirect(route(\'dashboard\', absolute: false));\n    }\n}\n