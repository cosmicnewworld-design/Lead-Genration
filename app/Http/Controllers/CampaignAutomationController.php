<?php\n\nnamespace App\\Http\\Controllers;\n\nuse App\\Jobs\\ProcessCampaignEmail;\nuse App\\Models\\Campaign;\nuse App\\Models\\CampaignRun;\nuse Illuminate\\Http\Request;\nuse Illuminate\\Support\\Facades\\Auth;\n\nclass CampaignAutomationController extends Controller\n{\n    public function start(Request $request, Campaign $campaign)\n    {\n        $this->authorize(\'start\', $campaign);\n\n        $request->validate([\n            \'lead_ids\' => \'required|array\',\n            \'lead_ids.*\' => \'exists:leads,id\',\n        ]);\n\n        // 1. Create a Campaign Run\n        $campaignRun = CampaignRun::create([\n            \'tenant_id\' => Auth::user()->tenant_id,\n            \'campaign_id\' => $campaign->id,\n            \'started_at\' => now(),\n            \'status\' => \'running\',\n        ]);\n\n        // 2. Attach leads to the campaign run\n        $campaignRun->leads()->attach($request->lead_ids, [\'tenant_id\' => Auth::user()->tenant_id]);\n\n        // 3. Get the first step of the campaign\n        $firstStep = $campaign->steps()->orderBy(\'order\', \'asc\')->first();\n\n        if (!$firstStep) {\n            return response()->json([\'message\' => \'This campaign has no steps.\'], 422);\n        }\n\n        // 4. Dispatch a job for each lead for the first step\n        foreach ($campaignRun->leads as $lead) {\n            $delay = now()->addDays($firstStep->delay_in_days);\n            ProcessCampaignEmail::dispatch(Auth::user()->tenant, $campaignRun, $lead, $firstStep)->delay($delay);\n        }\n\n        return response()->json([\'message\' => \'Campaign started successfully.\']);\n    }\n}\n