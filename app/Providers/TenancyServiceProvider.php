<?php\n\ndeclare(strict_types=1);\n\nnamespace App\\Providers;\n\nuse Illuminate\\Support\\Facades\\Event;\nuse Illuminate\Support\\Facades\\Route;\nuse Illuminate\\Support\\ServiceProvider;\nuse Stancl\\JobPipeline\\JobPipeline;\nuse Stancl\\Tenancy\\Events;\nuse Stancl\\Tenancy\\Jobs;\nuse Stancl\\Tenancy\\Listeners;\nuse Stancl\\Tenancy\\Middleware;\n\nclass TenancyServiceProvider extends ServiceProvider\n{\n    // By default, no namespace is used to support the callable array syntax.\n    public static string $controllerNamespace = \'\';\n\n    public function events()\n    {\n        return [\n            // Tenant events\n            Events\\CreatingTenant::class => [],\n            Events\\TenantCreated::class => [\n                JobPipeline::make([\n                    Jobs\\CreateDatabase::class,\n                    Jobs\\MigrateDatabase::class,\n                ])->send(function (Events\\TenantCreated $event) {\n                    return $event->tenant;\n                })->shouldBeQueued(true), // Use queues for production\n            ],\n            Events\\SavingTenant::class => [],\n            Events\\TenantSaved::class => [],\n            Events\\UpdatingTenant::class => [],\n            Events\\TenantUpdated::class => [],\n            Events\\DeletingTenant::class => [],\n            Events\\TenantDeleted::class => [\n                JobPipeline::make([\n                    Jobs\\DeleteDatabase::class,\n                ])->send(function (Events\\TenantDeleted $event) {\n                    return $event->tenant;\n                })->shouldBeQueued(true), // Use queues for production\n            ],\n\n            // ... other events\n        ];\n    }\n\n    public function register()\n    {\n        //\n    }\n\n    public function boot()\n    {\n        $this->bootEvents();\n        $this->mapRoutes();\n\n        $this->makeTenancyMiddlewareHighestPriority();\n    }\n\n    protected function bootEvents()\n    {\n        foreach ($this->events() as $event => $listeners) {\n            foreach ($listeners as $listener) {\n                if ($listener instanceof JobPipeline) {\n                    $listener = $listener->toListener();\n                }\n\n                Event::listen($event, $listener);\n            }\n        }\n    }\n\n    protected function mapRoutes()\n    {\n        Route::middleware([\'web\'])\n            ->namespace(static::$controllerNamespace)\n            ->group(base_path(\'routes/web.php\'));\n\n        Route::middleware([\n            \'web\',\n            Middleware\\InitializeTenancyByDomain::class,\n            Middleware\\PreventAccessFromCentralDomains::class,\n        ])\n            ->namespace(static::$controllerNamespace)\n            ->group(base_path(\'routes/tenant.php\'));\n    }\n\n    protected function makeTenancyMiddlewareHighestPriority()\n    {\n        $tenancyMiddleware = [\n            // Even higher priority than the initialization middleware\n            Middleware\\PreventAccessFromCentralDomains::class,\n\n            Middleware\\InitializeTenancyByDomain::class,\n            Middleware\\InitializeTenancyBySubdomain::class,\n            Middleware\\InitializeTenancyByDomainOrSubdomain::class,\n            Middleware\\InitializeTenancyByPath::class,\n            Middleware\\InitializeTenancyByRequestData::class,\n        ];\n\n        foreach (array_reverse($tenancyMiddleware) as $middleware) {\n            $this->app[\\Illuminate\\Contracts\\Http\\Kernel::class]->prependToMiddlewarePriority($middleware);\n        }\n    }\n}\n